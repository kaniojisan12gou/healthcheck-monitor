# 社内NW端末 Ping疎通確認ツール

社内ネットワーク内の端末に対して継続的にPing監視を行い、死活状態をリアルタイムで表示するシンプルなツールです。

## 機能

- 複数端末（20台程度）への継続的なPing監視
- リアルタイムでの死活状態表示
- マルチスレッド処理による並行監視
- **Slack通知機能（ホストダウン・復旧時に自動通知）**
- Windows/macOS/Linux対応

## ファイル構成

```
.
├── ping_monitor.py    # メインスクリプト
├── hosts.txt          # 監視対象ホストリスト
├── config.json        # 設定ファイル（Slack通知等）
└── README.md          # 本ファイル
```

## 使い方

### 1. 監視対象ホストの設定

`hosts.txt` に監視対象のIPアドレスまたはホスト名を1行に1つずつ記載します。

```
# hosts.txt の例
192.168.1.1
192.168.1.10
192.168.1.20
server01.local
server02.local
```

- `#` で始まる行はコメントとして扱われます
- 空行は無視されます

### 2. 監視の実行

```bash
python3 ping_monitor.py
```

### 3. 監視の停止

`Ctrl+C` で監視を終了します。

## Slack通知の設定

ホストがダウンした際や復旧した際にSlackへ自動通知することができます。

### 1. Slack Incoming Webhookの作成

1. Slackワークスペースで [Incoming Webhooks](https://api.slack.com/messaging/webhooks) を有効化
2. 通知先チャンネルを選択
3. Webhook URLを取得（例: `https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXX`）

### 2. config.jsonの編集

`config.json` を開いて、以下の設定を行います。

```json
{
  "slack": {
    "enabled": true,                                          // Slack通知の有効化（true/false）
    "webhook_url": "https://hooks.slack.com/services/YOUR/WEBHOOK/URL",  // 取得したWebhook URL
    "channel": "#network-alerts",                             // 通知先チャンネル名（表示用）
    "username": "Ping監視Bot",                                // 通知時の表示名
    "notify_on_down": true,                                   // ダウン時に通知（true/false）
    "notify_on_recovery": true,                               // 復旧時に通知（true/false）
    "down_threshold": 10,                                     // 通知するまでの連続NG回数（デフォルト: 10）
    "mention_users": ["U01234567"],                           // メンション対象ユーザーID（複数可）
    "mention_groups": ["S01234567"]                           // メンション対象グループID（複数可）
  },
  "monitor": {
    "interval": 5,                                            // Ping実行間隔（秒）
    "hosts_file": "hosts.txt"                                 // ホストリストファイル
  }
}
```

**メンション設定の取得方法:**
- **ユーザーID**: Slackでユーザーのプロフィールを開き、「︙」→「メンバーIDをコピー」
- **グループID**: ユーザーグループの管理画面から確認（例: `S01234567`）

### 3. 通知のタイミング

- **ホストダウン検知時**:
  - 連続で10回（down_thresholdで設定）Ping失敗した時点で通知
  - **初回のみメンション付き**（延々とメンションが飛ぶのを防止）
  - 11回目以降は通知されません

- **ホスト復旧時**:
  - **連続NGが10回以上だった対象のみ**通知（1〜9回のNG後の復旧は通知しない）
  - NG → OK に状態が変化したときに通知
  - **メンションなし**
  - 連続NG回数とメンションフラグがリセットされます

### 4. 通知内容

Slackに送信される通知には以下の情報が含まれます：

- ホスト（IPアドレスまたはホスト名）
- 状態（OK/NG）
- 連続失敗回数（ダウン検知時のみ）
- 検知時刻
- メンション（初回ダウン検知時のみ）

## 表示内容

```
================================================================================
                        社内NW端末 Ping監視ツール
================================================================================
監視対象: 21台 | 監視間隔: 5秒 | Slack通知: 有効
--------------------------------------------------------------------------------
ホスト               状態            連続NG     最終確認時刻
--------------------------------------------------------------------------------
192.168.11.4         ✗ NG           8回        2025-12-11 10:30:45
192.168.11.6         ✗ NG           15回       2025-12-11 10:30:46
192.168.11.7         ✓ OK           -          2025-12-11 10:30:47
...
```

- `✓ OK`: 疎通成功
- `✗ NG`: 疎通失敗
- **連続NG**: 連続してPingが失敗した回数（10回でSlack通知）

## カスタマイズ

`ping_monitor.py` の以下のパラメータで動作を調整できます。

```python
monitor = PingMonitor(
    hosts_file="hosts.txt",  # ホストリストファイルのパス
    interval=5               # Ping実行間隔（秒）
)
```

## 動作要件

- Python 3.6以上
- 標準ライブラリのみ使用（外部パッケージ不要）
- `ping` コマンドが実行可能な環境

## 注意事項

- ファイアウォールやセキュリティ設定でICMPパケット（Ping）がブロックされている場合、正常に動作しません
- 大量のホストを監視する場合、監視間隔を調整してネットワーク負荷を考慮してください
- 監視対象ホストが応答しない場合でも、ネットワーク障害とは限りません（電源オフ、Ping応答無効化等の可能性）
